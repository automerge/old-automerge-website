"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1663],{4112:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>m,frontMatter:()=>a,metadata:()=>o,toc:()=>h});const o=JSON.parse('{"id":"tutorial/persist-root-doc","title":"Persisting the Root Document","description":"Keeping Track of the Root Document","source":"@site/docs/tutorial/08-persist-root-doc.mdx","sourceDirName":"tutorial","slug":"/tutorial/persist-root-doc","permalink":"/docs/tutorial/persist-root-doc","draft":false,"unlisted":false,"editUrl":"https://github.com/automerge/automerge.github.io/edit/main/docs/tutorial/08-persist-root-doc.mdx","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"title":"Persisting the Root Document"},"sidebar":"tutorialSidebar","previous":{"title":"Multiple Task Lists","permalink":"/docs/tutorial/multiple-task-lists"},"next":{"title":"Multi Device Root Document","permalink":"/docs/tutorial/multi-device-root-doc"}}');var i=n(6070),r=n(4331),s=(n(9821),n(6423)),c=n(8628);const a={title:"Persisting the Root Document"},l=void 0,d={},h=[{value:"Keeping Track of the Root Document",id:"keeping-track-of-the-root-document",level:2},{value:"Using the Root Document",id:"using-the-root-document",level:2}];function u(e){const t={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"keeping-track-of-the-root-document",children:"Keeping Track of the Root Document"}),"\n",(0,i.jsx)(t.p,{children:"Putting all our task lists in a root document is great, but right now we don't persist the root document, instead creating a new one every time we load the app. To make the root document useful we're going to want to persist it somewhere. Unlike the individual task lists a root document isn't really \"the thing we're looking at\", but is more like a \"user account\" in that it is the context in which the rest of the application works."}),"\n",(0,i.jsxs)(t.p,{children:["To achieve this kind of usage we're going to store the root document ID in the browser's local storage. This way, even if you close the browser or refresh the page, your root document will still be there when you come back. Let's add some code to manage this process to ",(0,i.jsx)(t.code,{children:"src/rootDoc.ts"}),"."]}),"\n",(0,i.jsxs)(s.A,{children:[(0,i.jsx)(t.p,{children:"Create the root document management functions:"}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",metastring:'file="src/rootDoc.ts"',children:'// highlight-start\nimport { AutomergeUrl, Repo } from "@automerge/react";\n\nconst ROOT_DOC_URL_KEY = "root-doc-url";\n// highlight-end\n\nexport type RootDocument = {\n  taskLists: AutomergeUrl[];\n};\n\n// highlight-start\nexport const getOrCreateRoot = (repo: Repo): AutomergeUrl => {\n  // Check if we already have a root document\n  const existingUrl = localStorage.getItem(ROOT_DOC_URL_KEY);\n  if (existingUrl) {\n    return existingUrl as AutomergeUrl;\n  }\n\n  // Otherwise create one and (synchronously) store it\n  const root = repo.create<RootDocument>({ taskLists: [] });\n  localStorage.setItem(ROOT_DOC_URL_KEY, root.url);\n  return root.url;\n};\n// highlight-end\n'})})]}),"\n",(0,i.jsxs)(c.A,{children:[(0,i.jsx)(t.p,{children:"This code:"}),(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Uses ",(0,i.jsx)(t.code,{children:"localStorage"})," to persist the root document ID"]}),"\n",(0,i.jsx)(t.li,{children:"Provides a function to get/create the root document"}),"\n"]})]}),"\n",(0,i.jsx)(t.h2,{id:"using-the-root-document",children:"Using the Root Document"}),"\n",(0,i.jsx)(t.p,{children:"Let's update our main app to use the root document:"}),"\n",(0,i.jsxs)(s.A,{children:[(0,i.jsxs)(t.p,{children:["Update ",(0,i.jsx)(t.code,{children:"src/main.tsx"})," to initialize the root document:"]}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:'import React, { Suspense } from "react";\nimport ReactDOM from "react-dom/client";\nimport App from "./components/App.tsx";\nimport "./index.css";\n\nimport {\n  Repo,\n  BroadcastChannelNetworkAdapter,\n  WebSocketClientAdapter,\n  IndexedDBStorageAdapter,\n  RepoContext,\n  DocHandle,\n} from "@automerge/react";\n// highlight-next-line\nimport { getOrCreateRoot, RootDocument } from "./rootDoc.ts";\n\nconst repo = new Repo({\n  network: [\n    new BroadcastChannelNetworkAdapter(),\n    new WebSocketClientAdapter("wss://sync.automerge.org"),\n  ],\n  storage: new IndexedDBStorageAdapter(),\n});\n\n// Add the repo to the global window object so it can be accessed in the browser console\n// This is useful for debugging and testing purposes.\ndeclare global {\n  interface Window {\n    repo: Repo;\n    // We also add the handle to the global window object for debugging\n    handle: DocHandle<RootDocument>;\n  }\n}\nwindow.repo = repo;\n\n// highlight-start\nconst rootDocUrl = getOrCreateRoot(repo);\nwindow.handle = await repo.find(rootDocUrl);\n// highlight-end\n\nReactDOM.createRoot(document.getElementById("root")!).render(\n  <React.StrictMode>\n    <Suspense fallback={<div>Loading a document...</div>}>\n      <RepoContext.Provider value={repo}>\n        <App docUrl={window.handle.url} />\n      </RepoContext.Provider>\n    </Suspense>\n  </React.StrictMode>,\n);\n'})}),(0,i.jsxs)(t.p,{children:["Make sure you've removed this old code from ",(0,i.jsx)(t.code,{children:"src/main.tsx"}),":"]}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"// highlight-red-start\n- // Check the URL for a document to load\n- const locationHash = document.location.hash.substring(1);\n- // Depending if we have an AutomergeUrl, either find or create the document\n- if (isValidAutomergeUrl(locationHash)) {\n-   const taskList = await repo.find(locationHash);\n-   window.handle = repo.create({ taskLists: [taskList.url] });\n- } else {\n-  const taskList = repo.create<TaskList>(initTaskList());\n-   window.handle = repo.create({ taskLists: [taskList.url] });\n-   // Set the location hash to the new document we just made.\n-   document.location.hash = taskList.url;\n- }\n// highlight-red-end\n"})}),(0,i.jsx)(t.p,{children:"Note that we no longer pull a document from the location hash, but instead load it out of local storage."}),(0,i.jsx)(t.p,{children:"Let's validate that the root doc code is working so far:"}),(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:'Open your browser\'s developer tools (F12 or right-click and select "Inspect")'}),"\n",(0,i.jsx)(t.li,{children:'Go to the "Application" tab'}),"\n",(0,i.jsx)(t.li,{children:'In the left sidebar, under "Storage", expand "Local Storage" and click on your server'}),"\n",(0,i.jsxs)(t.li,{children:["Look for the ",(0,i.jsx)(t.code,{children:"root-doc-url"})," key - it should contain a URL starting with ",(0,i.jsx)(t.code,{children:"automerge:"})]}),"\n",(0,i.jsx)(t.li,{children:"Then, run this code in the developer console"}),"\n"]}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-js",children:'const rootDocUrl = localStorage.getItem("root-doc-url")\nconst root = await window.repo.find(rootDocUrl);\nconsole.log("Root document:", root.doc());\n'})}),(0,i.jsxs)(t.p,{children:["You should see a console log showing the root document with an empty ",(0,i.jsx)(t.code,{children:"taskLists"})," array."]}),(0,i.jsx)(t.p,{children:"If you open the application, you should be able to create multiple task lists and switch between them in the UI adding items. If you refresh the page, or copy the URL and open it in a new tab, you should see the same task lists and items because the root document URL is now being persisted in local storage."})]}),"\n",(0,i.jsx)(t.p,{children:"Now we have the foundation for our document management system. The root document serves as your personal storage space, keeping track of all documents you've opened. This makes it easy to find and access your documents again, even after closing the browser or switching devices."}),"\n",(0,i.jsx)(t.p,{children:"Next, we're going to add support for syncing our root document across devices."})]})}function m(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},4331:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>c});var o=n(758);const i={},r=o.createContext(i);function s(e){const t=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(r.Provider,{value:t},e.children)}},6423:(e,t,n)=>{n.d(t,{A:()=>i});n(758);var o=n(6070);function i(e){let{children:t}=e;return(0,o.jsxs)("div",{className:"exercise",children:[(0,o.jsx)("div",{className:"exercise-header",children:(0,o.jsx)("h3",{children:"Exercise"})}),(0,o.jsx)("div",{className:"exercise-content",children:t})]})}},8628:(e,t,n)=>{n.d(t,{A:()=>i});n(758);var o=n(6070);function i(e){let{children:t}=e;return(0,o.jsxs)("div",{className:"solution",children:[(0,o.jsx)("div",{className:"solution-header",children:(0,o.jsx)("h4",{children:"Solution"})}),(0,o.jsx)("div",{className:"solution-content",children:t})]})}},9821:(e,t,n)=>{n.d(t,{A:()=>M});var o=n(758),i=n(6070);function r(e){const{mdxAdmonitionTitle:t,rest:n}=function(e){const t=o.Children.toArray(e),n=t.find((e=>o.isValidElement(e)&&"mdxAdmonitionTitle"===e.type)),r=t.filter((e=>e!==n)),s=n?.props.children;return{mdxAdmonitionTitle:s,rest:r.length>0?(0,i.jsx)(i.Fragment,{children:r}):null}}(e.children),r=e.title??t;return{...e,...r&&{title:r},children:n}}var s=n(3526),c=n(1311),a=n(7967);const l="admonition_BudP",d="admonitionHeading_3rRN",h="admonitionIcon_GUtA",u="admonitionContent_Y5R8";function m(e){let{type:t,className:n,children:o}=e;return(0,i.jsx)("div",{className:(0,s.A)(a.G.common.admonition,a.G.common.admonitionType(t),l,n),children:o})}function p(e){let{icon:t,title:n}=e;return(0,i.jsxs)("div",{className:d,children:[(0,i.jsx)("span",{className:h,children:t}),n]})}function g(e){let{children:t}=e;return t?(0,i.jsx)("div",{className:u,children:t}):null}function x(e){const{type:t,icon:n,title:o,children:r,className:s}=e;return(0,i.jsxs)(m,{type:t,className:s,children:[o||n?(0,i.jsx)(p,{title:o,icon:n}):null,(0,i.jsx)(g,{children:r})]})}function f(e){return(0,i.jsx)("svg",{viewBox:"0 0 14 16",...e,children:(0,i.jsx)("path",{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})})}const j={icon:(0,i.jsx)(f,{}),title:(0,i.jsx)(c.A,{id:"theme.admonition.note",description:"The default label used for the Note admonition (:::note)",children:"note"})};function w(e){return(0,i.jsx)(x,{...j,...e,className:(0,s.A)("alert alert--secondary",e.className),children:e.children})}function v(e){return(0,i.jsx)("svg",{viewBox:"0 0 12 16",...e,children:(0,i.jsx)("path",{fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"})})}const k={icon:(0,i.jsx)(v,{}),title:(0,i.jsx)(c.A,{id:"theme.admonition.tip",description:"The default label used for the Tip admonition (:::tip)",children:"tip"})};function R(e){return(0,i.jsx)(x,{...k,...e,className:(0,s.A)("alert alert--success",e.className),children:e.children})}function b(e){return(0,i.jsx)("svg",{viewBox:"0 0 14 16",...e,children:(0,i.jsx)("path",{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})})}const y={icon:(0,i.jsx)(b,{}),title:(0,i.jsx)(c.A,{id:"theme.admonition.info",description:"The default label used for the Info admonition (:::info)",children:"info"})};function A(e){return(0,i.jsx)(x,{...y,...e,className:(0,s.A)("alert alert--info",e.className),children:e.children})}function N(e){return(0,i.jsx)("svg",{viewBox:"0 0 16 16",...e,children:(0,i.jsx)("path",{fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"})})}const D={icon:(0,i.jsx)(N,{}),title:(0,i.jsx)(c.A,{id:"theme.admonition.warning",description:"The default label used for the Warning admonition (:::warning)",children:"warning"})};function C(e){return(0,i.jsx)("svg",{viewBox:"0 0 12 16",...e,children:(0,i.jsx)("path",{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})})}const U={icon:(0,i.jsx)(C,{}),title:(0,i.jsx)(c.A,{id:"theme.admonition.danger",description:"The default label used for the Danger admonition (:::danger)",children:"danger"})};const L={icon:(0,i.jsx)(N,{}),title:(0,i.jsx)(c.A,{id:"theme.admonition.caution",description:"The default label used for the Caution admonition (:::caution)",children:"caution"})};const T={...{note:w,tip:R,info:A,warning:function(e){return(0,i.jsx)(x,{...D,...e,className:(0,s.A)("alert alert--warning",e.className),children:e.children})},danger:function(e){return(0,i.jsx)(x,{...U,...e,className:(0,s.A)("alert alert--danger",e.className),children:e.children})}},...{secondary:e=>(0,i.jsx)(w,{title:"secondary",...e}),important:e=>(0,i.jsx)(A,{title:"important",...e}),success:e=>(0,i.jsx)(R,{title:"success",...e}),caution:function(e){return(0,i.jsx)(x,{...L,...e,className:(0,s.A)("alert alert--warning",e.className),children:e.children})}}};function M(e){const t=r(e),n=(o=t.type,T[o]||(console.warn(`No admonition component found for admonition type "${o}". Using Info as fallback.`),T.info));var o;return(0,i.jsx)(n,{...t})}}}]);