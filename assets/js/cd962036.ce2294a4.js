"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[8066],{3476:(e,n,t)=>{t.d(n,{A:()=>o});t(6540);var s=t(4848);function o({children:e}){return(0,s.jsxs)("div",{className:"exercise",children:[(0,s.jsx)("div",{className:"exercise-header",children:(0,s.jsx)("h3",{children:"Exercise"})}),(0,s.jsx)("div",{className:"exercise-content",children:e})]})}},4903:(e,n,t)=>{t.d(n,{A:()=>o});t(6540);var s=t(4848);function o({children:e}){return(0,s.jsxs)("div",{className:"solution",children:[(0,s.jsx)("div",{className:"solution-header",children:(0,s.jsx)("h4",{children:"Solution"})}),(0,s.jsx)("div",{className:"solution-content",children:e})]})}},5646:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>l,default:()=>g,frontMatter:()=>d,metadata:()=>s,toc:()=>p});const s=JSON.parse('{"id":"tutorial/local-sync","title":"Local Storage & Sync","description":"Storage & Network Adapters","source":"@site/docs/tutorial/03-local-sync.mdx","sourceDirName":"tutorial","slug":"/tutorial/local-sync","permalink":"/docs/tutorial/local-sync","draft":false,"unlisted":false,"editUrl":"https://github.com/automerge/automerge.github.io/edit/main/docs/tutorial/03-local-sync.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Local Storage & Sync"},"sidebar":"tutorialSidebar","previous":{"title":"Core Concepts","permalink":"/docs/tutorial/concepts"},"next":{"title":"Load documents by URL","permalink":"/docs/tutorial/load_by_url"}}');var o=t(4848),a=t(8453),r=(t(2362),t(5537)),c=t(9329),i=t(3476);t(4903);const d={title:"Local Storage & Sync"},l=void 0,h={},p=[{value:"Storage &amp; Network Adapters",id:"storage--network-adapters",level:2},{value:"Create a Repo to hold your documents",id:"create-a-repo-to-hold-your-documents",level:4},{value:"Testing Storage and Sync",id:"testing-storage-and-sync",level:3}];function u(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"storage--network-adapters",children:"Storage & Network Adapters"}),"\n",(0,o.jsx)(n.p,{children:"Currently, the task list app doesn't persist or sync any changes, even locally."}),"\n",(0,o.jsx)(n.p,{children:"To prepare to add local multiplayer capabilities to the app, you'll initialize a local-first Repo to:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["save Docs client-side in the browser's ",(0,o.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API",children:"IndexedDB"}),", using the ",(0,o.jsx)(n.code,{children:"IndexedDBStorageAdapter"})," from ",(0,o.jsx)(n.code,{children:"@automerge/automerge-repo-storage-indexeddb"})]}),"\n",(0,o.jsxs)(n.li,{children:["keep local users (i.e. tabs within the same browser/origin) in sync via a ",(0,o.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API",children:"BroadcastChannel"}),", using the ",(0,o.jsx)(n.code,{children:"BroadcastChannelNetworkAdapter"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(i.A,{children:[(0,o.jsx)(n.h4,{id:"create-a-repo-to-hold-your-documents",children:"Create a Repo to hold your documents"}),(0,o.jsxs)(n.p,{children:["Start by adding ",(0,o.jsx)(n.code,{children:"@automerge/react"})," to your project."]}),(0,o.jsxs)(r.A,{children:[(0,o.jsx)(c.A,{value:"npm",label:"npm",children:(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# highlight-next-line\n$ npm install @automerge/react\n# ...installing dependencies...\n"})})}),(0,o.jsx)(c.A,{value:"yarn",label:"yarn",children:(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# highlight-next-line\n$ yarn add @automerge/react\n# ...installing dependencies...\n"})})}),(0,o.jsx)(c.A,{value:"pnpm",label:"pnpm",children:(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# highlight-next-line\n$ pnpm add @automerge/react\n# ...installing dependencies...\n"})})})]}),(0,o.jsxs)(n.p,{children:["In ",(0,o.jsx)(n.code,{children:"src/main.tsx"}),", import ",(0,o.jsx)(n.code,{children:"@automerge/react"})," and create a Repo object configured with networking and storage."]}),(0,o.jsx)(n.p,{children:"We'll start by storing our data in IndexedDB so we don't lose it when we refresh the browser, and we'll use the inefficient but simple BroadcastChannel networking adapter to keep our browser tabs in sync."}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tsx",metastring:'title="src/main.tsx"',children:'import React, { Suspense } from "react";\nimport ReactDOM from "react-dom/client";\nimport App from "./components/App.tsx";\nimport "./index.css";\n\nimport { initTaskList } from "./components/TaskList.tsx";\n\n// highlight-start\nimport {\n  Repo,\n  WebSocketClientAdapter,\n  IndexedDBStorageAdapter,\n} from "@automerge/react";\n\nconst repo = new Repo({\n  network: [new WebSocketClientAdapter("wss://sync.automerge.org")],\n  storage: new IndexedDBStorageAdapter(),\n});\n\n// Add the repo to the global window object so it can be accessed in the browser console\n// This is useful for debugging and testing purposes.\ndeclare global {\n  interface Window {\n    repo: Repo;\n  }\n}\nwindow.repo = repo;\n// highlight-end\n\nReactDOM.createRoot(document.getElementById("root")!).render(\n  <React.StrictMode>\n    <Suspense fallback={<div>Loading a document...</div>}>\n      <App taskList={initTaskList()} />\n    </Suspense>\n  </React.StrictMode>,\n);\n'})}),(0,o.jsx)(n.p,{children:"There are lots of other storage and networking adapters for all kinds of different environments. We'll see more of them later."})]}),"\n",(0,o.jsx)(n.h3,{id:"testing-storage-and-sync",children:"Testing Storage and Sync"}),"\n",(0,o.jsx)(n.p,{children:"Now that we have the Repo set up with local storage and sync, we can create documents and check that changes are synced between tabs by:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Opening the app in two different browser tabs"}),"\n",(0,o.jsx)(n.li,{children:"Making changes in one tab"}),"\n",(0,o.jsx)(n.li,{children:"Seeing those changes appear in the other tab"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Let's do that:"}),"\n",(0,o.jsxs)(n.p,{children:["We've added the ",(0,o.jsx)(n.code,{children:"Repo"})," to the global ",(0,o.jsx)(n.code,{children:"window"})," object so you can access it in the browser console - this is not something you would do in production code but we can use it now to check everything is working."]}),"\n",(0,o.jsx)(n.p,{children:"Open the app in two tabs, in the first tab open the browser console and type:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const handle = window.repo.create({foo: "bar"})\nconsole.log(handle.url)\n'})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"repo.create"})," create a new document, saving it in the ",(0,o.jsx)(n.code,{children:"StorageAdapter"})," and announcing it to the network via the ",(0,o.jsx)(n.code,{children:"NetworkAdapter"}),"; and returns a ",(0,o.jsx)(n.code,{children:"DocHandle"})," which allows us to access the document and URL which can be used to find it later."]}),"\n",(0,o.jsx)(n.p,{children:"In the second tab type"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'const handle = await window.repo.find("<paste the URL from the first tab here>")\nconsole.log(handle.doc())\n'})}),"\n",(0,o.jsx)(n.p,{children:"You should see the document in the second tab."}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"Repo.find"})," looks up a document by its URL, it checks local storage and asks any connected peers for the document. In this case because we are using the ",(0,o.jsx)(n.code,{children:"IndexedDBStorageAdapter"})," it will find the document locally."]}),"\n",(0,o.jsx)(n.p,{children:"Now let's listen for new changes. In the second tab console type:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'handle.on("change", evt => console.log(evt.doc))\n'})}),"\n",(0,o.jsx)(n.p,{children:"Then in the first tab console type:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-js",children:'handle.change(doc => doc.foo = "baz")\n'})}),"\n",(0,o.jsxs)(n.p,{children:["If you switch back to the second tab, you should see the updated document logged in the console. This is because the ",(0,o.jsx)(n.code,{children:"BroadcastChannelNetworkAdapter"})," is sending changes to other connected tabs."]})]})}function g(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}}}]);